apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: pdf-processor-worker-hpa
  namespace: default
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: pdf-processor-worker

  # ğŸ”¥ è‡ªåŠ¨æ‰©ç¼©å®¹é…ç½®
  minReplicas: 2 # æœ€å°‘ 2 ä¸ª worker
  maxReplicas: 10 # æœ€å¤š 10 ä¸ª worker

  # æ‰©ç¼©å®¹æŒ‡æ ‡
  metrics:
    # åŸºäº CPU ä½¿ç”¨ç‡
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70 # CPU è¶…è¿‡ 70% æ—¶æ‰©å®¹

    # åŸºäºå†…å­˜ä½¿ç”¨ç‡
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80 # å†…å­˜è¶…è¿‡ 80% æ—¶æ‰©å®¹

  # æ‰©ç¼©å®¹è¡Œä¸ºæ§åˆ¶
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300 # 5åˆ†é’Ÿç¨³å®šæœŸ
      policies:
        - type: Percent
          value: 50 # æ¯æ¬¡æœ€å¤šç¼©å®¹ 50%
          periodSeconds: 60 # æ¯åˆ†é’Ÿ
    scaleUp:
      stabilizationWindowSeconds: 60 # 1åˆ†é’Ÿç¨³å®šæœŸ
      policies:
        - type: Percent
          value: 100 # æ¯æ¬¡æœ€å¤šæ‰©å®¹ 100%ï¼ˆç¿»å€ï¼‰
          periodSeconds: 30 # æ¯ 30 ç§’
        - type: Pods
          value: 2 # æ¯æ¬¡æœ€å¤šå¢åŠ  2 ä¸ª pod
          periodSeconds: 30

---
# å¯é€‰ï¼šåŸºäºè‡ªå®šä¹‰æŒ‡æ ‡ï¼ˆRedis é˜Ÿåˆ—é•¿åº¦ï¼‰æ‰©ç¼©å®¹
# éœ€è¦å®‰è£… Prometheus å’Œ KEDA
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: pdf-processor-worker-scaler
  namespace: default
spec:
  scaleTargetRef:
    name: pdf-processor-worker

  minReplicaCount: 2
  maxReplicaCount: 20

  triggers:
    # åŸºäº Redis é˜Ÿåˆ—é•¿åº¦
    - type: redis
      metadata:
        address: redis-service:6379
        listName: queue:upload_tasks
        listLength: "5" # é˜Ÿåˆ—è¶…è¿‡ 5 ä¸ªä»»åŠ¡æ—¶æ‰©å®¹
        activationListLength: "1" # è‡³å°‘ 1 ä¸ªä»»åŠ¡æ‰æ¿€æ´»
