apiVersion: apps/v1
kind: Deployment
metadata:
  name: pdf-processor-worker
  namespace: default
  labels:
    app: pdf-processor
    component: worker
spec:
  # ğŸ”¥ å¹¶å‘æ§åˆ¶ï¼šé€šè¿‡ replicas æ•°é‡æ§åˆ¶ worker å¹¶å‘
  replicas: 3 # 3ä¸ª worker åŒæ—¶å¤„ç†ä»»åŠ¡

  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1 # æ›´æ–°æ—¶æœ€å¤šå¢åŠ 1ä¸ªpod
      maxUnavailable: 1 # æ›´æ–°æ—¶æœ€å¤š1ä¸ªpodä¸å¯ç”¨

  selector:
    matchLabels:
      app: pdf-processor
      component: worker

  template:
    metadata:
      labels:
        app: pdf-processor
        component: worker
    spec:
      # ä¼˜é›…é€€å‡ºæ—¶é—´
      terminationGracePeriodSeconds: 60

      containers:
        - name: worker
          image: your-registry/pdf-processor:latest
          imagePullPolicy: IfNotPresent

          # å¯åŠ¨å‘½ä»¤
          command: ["python", "-m", "tasks.redis_worker"]

          # èµ„æºé™åˆ¶
          resources:
            requests:
              cpu: "500m" # 0.5 æ ¸å¿ƒ
              memory: "1Gi" # 1GB å†…å­˜
            limits:
              cpu: "2000m" # æœ€å¤š 2 æ ¸å¿ƒ
              memory: "4Gi" # æœ€å¤š 4GB å†…å­˜

          # ç¯å¢ƒå˜é‡ï¼ˆä» ConfigMap å’Œ Secret è¯»å–ï¼‰
          env:
            - name: REDIS_URL
              valueFrom:
                configMapKeyRef:
                  name: pdf-processor-config
                  key: redis_url

            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: pdf-processor-secrets
                  key: redis_password
                  optional: true

            - name: REDIS_QUEUE_NAME
              valueFrom:
                configMapKeyRef:
                  name: pdf-processor-config
                  key: redis_queue_name

            - name: GO_GRPC_INGEST_ADDR
              valueFrom:
                configMapKeyRef:
                  name: pdf-processor-config
                  key: go_grpc_ingest_addr

            - name: GRPC_SERVER_PORT
              valueFrom:
                configMapKeyRef:
                  name: pdf-processor-config
                  key: grpc_server_port

            - name: BUCKET_ENDPOINT
              valueFrom:
                configMapKeyRef:
                  name: pdf-processor-config
                  key: bucket_endpoint

            - name: BUCKET_NAME
              valueFrom:
                configMapKeyRef:
                  name: pdf-processor-config
                  key: bucket_name

            - name: BUCKET_ACCESS_ID
              valueFrom:
                secretKeyRef:
                  name: pdf-processor-secrets
                  key: bucket_access_id

            - name: BUCKET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: pdf-processor-secrets
                  key: bucket_access_key

            - name: LOG_LEVEL
              value: "INFO"

          # gRPC ç«¯å£æš´éœ²
          ports:
            - name: grpc-apikey
              containerPort: 50052
              protocol: TCP

          # å¥åº·æ£€æŸ¥
          livenessProbe:
            exec:
              command:
                - python
                - -c
                - "import redis; redis.from_url('$(REDIS_URL)').ping()"
            initialDelaySeconds: 30
            periodSeconds: 30
            timeoutSeconds: 5
            failureThreshold: 3

          readinessProbe:
            exec:
              command:
                - python
                - -c
                - "import redis; redis.from_url('$(REDIS_URL)').ping()"
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3

          # æŒ‚è½½ä¸´æ—¶ç›®å½•
          volumeMounts:
            - name: temp-storage
              mountPath: /tmp/pdf_processor

      volumes:
        - name: temp-storage
          emptyDir:
            sizeLimit: 10Gi # ä¸´æ—¶å­˜å‚¨æœ€å¤š 10GB

---
apiVersion: v1
kind: Service
metadata:
  name: pdf-processor-worker
  namespace: default
  labels:
    app: pdf-processor
    component: worker
spec:
  type: ClusterIP
  ports:
    - name: grpc-apikey
      port: 50052
      targetPort: 50052
      protocol: TCP
  selector:
    app: pdf-processor
    component: worker
  # ä½¿ç”¨ Headless Serviceï¼ŒGo å¯ä»¥ç›´æ¥è®¿é—®æ‰€æœ‰ Pod
  clusterIP: None
